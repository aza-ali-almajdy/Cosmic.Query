<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Learning Flashcard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0F0C29;
            --bg-mid: #302B63;
            --bg-light: #24243E;
            --accent-cyan: #00F5D4;
            --accent-magenta: #9B5DE5;
            --text-light: #F6F7F8;
            --text-mid: #A9A8C3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-mid) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            overflow-x: hidden;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3.236 67.5L0 50l3.236-17.5L20.736 25l17.5-17.5L50 0l11.764 7.5L79.264 25l17.5 17.5L100 50l-3.236 17.5L79.264 75l-17.5 17.5L50 100l-11.764-7.5L20.736 75z' fill='%23fff' fill-opacity='.1'/%3E%3C/svg%3E");
            animation: move-stars 120s linear infinite;
        }
        
        @keyframes move-stars {
            from { background-position: 0 0; }
            to { background-position: 0 1000px; }
        }

        .mobile-card-container {
            width: 340px;
            height: 600px;
            max-width: 90vw;
            max-height: 85vh;
            perspective: 2000px;
            z-index: 1;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.9s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        
        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            background-color: var(--bg-light);
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 20px 20px;
            border-radius: 25px;
            overflow: hidden;
            border: 2px solid rgba(0, 245, 212, 0.3);
            box-shadow: 
                0 20px 60px -15px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(155, 93, 229, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px;
            text-align: center;
        }
        
        .card-face > main {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 15px;
        }
        
        .card-back {
            transform: rotateY(180deg);
        }
        
        .card-header, .card-footer {
             width: 100%;
             z-index: 2;
        }

        .card-footer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            padding-top: 10px;
        }
        
        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: var(--text-light);
            text-shadow: 0 0 10px var(--accent-cyan);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .planet-container {
            position: relative;
            animation: float 6s ease-in-out infinite;
        }
        
        .planet-svg {
            width: 200px;
            height: auto;
        }

        .question-mark-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: white;
            opacity: 0.8;
            text-shadow: 0 0 15px rgba(0, 245, 212, 0.7);
        }
        
        .question-text-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 245, 212, 0.3);
            min-height: 80px;
            width: 100%;
        }

        .question-text-box p:first-child {
            color: var(--text-mid);
            font-size: 14px;
        }
        .question-text-box p:last-child {
            color: var(--text-light);
            font-size: 20px;
            font-weight: 600;
        }

        .astronaut-container {
            width: 150px;
            height: auto;
            animation: float 8s ease-in-out infinite reverse;
        }

        .answer-box {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(155, 93, 229, 0.5);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            min-height: 150px;
        }

        .answer-sentence {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-light);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .answer-sentence .highlight {
            color: var(--accent-cyan);
            font-weight: 700;
            text-shadow: 0 0 8px var(--accent-cyan);
        }
        
        .grammar-explanation {
            font-size: 14px;
            color: var(--text-mid);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 8px;
        }

        .grammar-explanation i {
            color: var(--accent-magenta);
        }

        .tts-button {
            background: none;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .tts-button:hover:not(:disabled) {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }
        
        .action-button {
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
            color: var(--bg-dark);
            border: none;
            padding: 15px 20px;
            width: 100%;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 10px 25px -10px var(--accent-cyan);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-button.secondary {
            background: rgba(0,0,0,0.2);
            color: var(--text-light);
            border: 1px solid var(--accent-magenta);
            box-shadow: none;
        }

        .action-button:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px -10px var(--accent-magenta);
        }

        .action-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
            animation: pulse 1.5s infinite;
        }

        .teacher-name {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--text-light);
            text-shadow: 0 0 10px var(--accent-cyan), 0 0 20px var(--accent-magenta);
            z-index: 100;
            padding: 8px 20px;
            background-color: rgba(48, 43, 99, 0.5);
            border: 1px solid rgba(0, 245, 212, 0.3);
            border-radius: 50px;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 245, 212, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 245, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 245, 212, 0); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        
        @media (max-width: 767px) {
            body {
                padding: 20px;
            }
            .teacher-name {
                font-size: 18px;
                top: 10px;
            }
            .mobile-card-container {
                width: 100%;
                max-width: 380px;
                height: 620px;
                max-height: 85vh;
            }
            .card-face {
                border-radius: 20px;
                padding: 20px;
            }
            .planet-svg {
                width: 160px;
            }
            .astronaut-container {
                width: 120px;
            }
            .card-title {
                font-size: 20px;
            }
            .answer-sentence {
                font-size: 20px;
            }
            .question-text-box p:last-child {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="teacher-name">T. Azza</div>
    <div class="stars"></div>
    <div class="mobile-card-container">
        <div class="card-inner" id="cardInner">
            <div class="card-face card-front">
                <header class="card-header">
                    <h2 class="card-title"><i class="fas fa-satellite-dish"></i> Cosmic Query</h2>
                </header>
                
                <main>
                    <div class="planet-container">
                        <i class="fas fa-question question-mark-icon"></i>
                        <svg class="planet-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <radialGradient id="planetGradient" cx="30%" cy="30%" r="70%">
                                    <stop offset="0%" style="stop-color: #9B5DE5;" />
                                    <stop offset="100%" style="stop-color: #302B63;" />
                                </radialGradient>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <path d="M 100,55 A 100,30 0 1 0 100,145 A 100,30 0 1 0 100,55 Z" fill="none" stroke="#00F5D4" stroke-width="3" filter="url(#glow)"/>
                            <circle cx="100" cy="100" r="60" fill="url(#planetGradient)" />
                        </svg>
                    </div>
                    <div class="question-text-box" id="questionBox">
                        <p id="questionPrompt"></p>
                        <p id="questionContent"></p>
                    </div>
                </main>

                <footer class="card-footer">
                    <button class="action-button" onclick="flipCard()">
                        <span>Reveal Answer</span>
                        <i class="fas fa-rocket"></i>
                    </button>
                </footer>
            </div>

            <div class="card-face card-back">
                <header class="card-header">
                     <h2 class="card-title"><i class="fas fa-user-astronaut"></i> Mission Debrief</h2>
                </header>

                <main>
                    <svg class="astronaut-container" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="astronautGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#F6F7F8;"/>
                                <stop offset="100%" style="stop-color:#A9A8C3;"/>
                            </linearGradient>
                            <filter id="astroGlow">
                                <feDropShadow dx="0" dy="0" stdDeviation="3" flood-color="#9B5DE5"/>
                            </filter>
                        </defs>
                        <g filter="url(#astroGlow)">
                            <path fill="#302B63" d="M50 8c-8.8 0-16 7.2-16 16s7.2 16 16 16 16-7.2 16-16S58.8 8 50 8z"/>
                            <path fill="url(#astronautGradient)" d="M50 10c-7.7 0-14 6.3-14 14s6.3 14 14 14 14-6.3 14-14-6.3-14-14z"/>
                            <path fill="#00F5D4" d="M40 20h20v8H40z" opacity="0.7"/>
                            <path fill="url(#astronautGradient)" d="M68 40H32c-4.4 0-8 3.6-8 8v28c0 4.4 3.6 8 8 8h36c4.4 0 8-3.6 8-8V48c0-4.4-3.6-8-8-8z"/>
                            <rect x="45" y="55" width="10" height="10" rx="2" fill="#302B63"/>
                        </g>
                    </svg>
                    <div class="answer-box">
                        <button class="tts-button" id="ttsButton" onclick="speakAnswer()">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <p class="answer-sentence" id="answerSentence"></p>
                        <div class="grammar-explanation" id="grammarExplanation">
                            <i class="fas fa-info-circle"></i>
                            <span></span>
                        </div>
                    </div>
                </main>
                
                <footer class="card-footer">
                    <button class="action-button" id="nextChallengeButton" onclick="nextChallenge()">
                            ✨ New Challenge
                    </button>
                    <button class="action-button secondary" onclick="flipCard()">
                        <i class="fas fa-sync-alt"></i>
                        <span>Back to Query</span>
                    </button>
                </footer>
            </div>
        </div>
    </div>

    <script>
        const cardInner = document.getElementById('cardInner');
        const nextChallengeButton = document.getElementById('nextChallengeButton');
        const ttsButton = document.getElementById('ttsButton');

        const questionPromptEl = document.getElementById('questionPrompt');
        const questionContentEl = document.getElementById('questionContent');
        const answerSentenceEl = document.getElementById('answerSentence');
        const grammarExplanationEl = document.getElementById('grammarExplanation').querySelector('span');
        
        let currentAnswer = "";
        let currentChallengeIndex = 0;
        let shuffledChallenges = [];

        const challenges = [
            // New Challenges Added:
            { prompt: "She / write her homework", tense: "Future (going to)", answer_sentence: "She is going to write her homework.", conjugated_verb: "is going to write", explanation: "Use 'is going to' + base verb for future intention with singular subjects (she/he/it)." },
            { prompt: "They / go to school", tense: "Future (going to)", answer_sentence: "They are going to go to school.", conjugated_verb: "are going to go", explanation: "Use 'are going to' + base verb for future intention with plural subjects (they/we/you)." },
            { prompt: "She is the woman. / She cuts my hair.", tense: "Relative Clause (Who)", answer_sentence: "She is the woman who cuts my hair.", conjugated_verb: "who cuts", explanation: "Use the relative pronoun 'who' to connect the clauses and refer to a person (the woman)." },
            // Original Challenges:
            { prompt: "She / write / a novel", tense: "Past Tense", answer_sentence: "She wrote a novel.", conjugated_verb: "wrote", explanation: "'Wrote' is the irregular past tense of 'write'." },
            { prompt: "They / go / to school", tense: "Past Simple Tense", answer_sentence: "They went to school.", conjugated_verb: "went", explanation: "'Went' is the irregular past tense of 'go'." },
            { prompt: "He / play / football", tense: "Present Progressive Tense", answer_sentence: "He is playing football.", conjugated_verb: "is playing", explanation: "Use 'is' + verb-ing for he/she/it in present progressive." },
            { prompt: "We / speak / English", tense: "Present Progressive Tense", answer_sentence: "We are speaking English.", conjugated_verb: "are speaking", explanation: "Use 'are' + verb-ing for we/they/you in present progressive." },
            { prompt: "They slept", tense: "Make Negative", answer_sentence: "They did not sleep.", conjugated_verb: "did not sleep", explanation: "To make a past simple sentence negative, use 'did not' + base verb." },
            { prompt: "He went to Abha", tense: "Make Negative", answer_sentence: "He did not go to Abha.", conjugated_verb: "did not go", explanation: "Use 'did not' and the base form of the verb 'go'." },
            { prompt: "I / be / a student", tense: "Talk about yourself (Present Simple)", answer_sentence: "I am a student.", conjugated_verb: "am", explanation: "Use 'am' for the verb 'be' with the pronoun 'I'." },
            { prompt: "Ali / eat / an apple", tense: "Present Simple Tense", answer_sentence: "Ali eats an apple.", conjugated_verb: "eats", explanation: "Add '-s' to the verb for third-person singular (Ali) in the present simple." },
            { prompt: "She / cook / food", tense: "Present Simple Tense", answer_sentence: "She cooks food.", conjugated_verb: "cooks", explanation: "Add '-s' to the verb for 'she' in the present simple." },
            { prompt: "He / read / novels", tense: "Used To", answer_sentence: "He used to read novels.", conjugated_verb: "used to read", explanation: "'Used to' describes a past habit or state that is no longer true." },
            { prompt: "She / listen / to the teacher", tense: "Used To", answer_sentence: "She used to listen to the teacher.", conjugated_verb: "used to listen", explanation: "'Used to' is followed by the base form of the verb." }
        ];

        function flipCard() {
            cardInner.classList.toggle('is-flipped');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function displayChallenge(index) {
            const challenge = shuffledChallenges[index];
            
            questionPromptEl.textContent = `Task: ${challenge.tense}`;
            questionContentEl.textContent = challenge.prompt;
            grammarExplanationEl.textContent = challenge.explanation;
            currentAnswer = challenge.answer_sentence;

            const highlightedSentence = challenge.answer_sentence.replace(
                challenge.conjugated_verb,
                `<span class="highlight">${challenge.conjugated_verb}</span>`
            );
            answerSentenceEl.innerHTML = highlightedSentence;
            
            if (cardInner.classList.contains('is-flipped')) {
                flipCard();
            }
        }

        function nextChallenge() {
            currentChallengeIndex++;
            if (currentChallengeIndex >= shuffledChallenges.length) {
                currentChallengeIndex = 0;
                shuffleArray(shuffledChallenges);
            }
            displayChallenge(currentChallengeIndex);
            nextChallengeButton.textContent = "✨ New Challenge";
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            shuffledChallenges = [...challenges];
            shuffleArray(shuffledChallenges);
            displayChallenge(currentChallengeIndex);
        });
        
        // --- TTS API Functions ---

        const apiKey = ""; 
        const ttsModel = "gemini-2.5-flash-preview-tts";
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${ttsModel}:generateContent?key=${apiKey}`;
        const TTS_VOICE = "Zephyr"; // تم التغيير إلى Zephyr (صوت مشرق)
        const MAX_RETRIES = 3;

        // Converts a Base64 string to an ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Converts PCM data to a WAV Blob
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset + i, s.charCodeAt(i));
                }
                offset += s.length;
            }

            // RIFF chunk
            writeString('RIFF');
            view.setUint32(offset, 36 + dataSize, true); offset += 4;
            writeString('WAVE');

            // fmt chunk
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4; // Sub-chunk size (16 for PCM)
            view.setUint16(offset, 1, true); offset += 2; // Audio Format (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2; // Bits per sample (16)

            // data chunk
            writeString('data');
            view.setUint32(offset, dataSize, true); offset += 4;

            // Write PCM data
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        async function fetchTtsWithRetry(payload, retries = MAX_RETRIES) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(ttsApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }
                    
                    if (response.status === 401 || response.status === 403) {
                         console.warn(`TTS API failed with status ${response.status}. This usually indicates an authentication issue (API key problem).`);
                    }

                    // If not OK, and it's not the last retry, wait with exponential backoff
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.floor(Math.random() * 1000);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`TTS API failed after ${retries} attempts: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                         throw new Error(`TTS API request error after ${retries} attempts: ${error.message}`);
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.floor(Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        async function speakAnswer() {
            if (!currentAnswer) return;

            const originalIcon = ttsButton.innerHTML;
            
            // 1. Store the original explanation text to restore it later
            const originalExplanation = grammarExplanationEl.textContent; 

            // Set loading state
            ttsButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            ttsButton.disabled = true;

            const payload = {
                contents: [{
                    parts: [{ text: currentAnswer }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: TTS_VOICE }
                        }
                    }
                }
            };

            let audioUrl;
            let audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) audioPlayer.pause();

            try {
                const result = await fetchTtsWithRetry(payload);

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (!audioData || !mimeType || !mimeType.startsWith("audio/L16")) {
                    throw new Error("Invalid audio response from API.");
                }

                // 1. Extract Sample Rate
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                
                // 2. Convert Base64 to PCM ArrayBuffer
                const pcmDataBuffer = base64ToArrayBuffer(audioData);
                
                // 3. API returns signed PCM16 audio data.
                const pcm16 = new Int16Array(pcmDataBuffer);
                
                // 4. Convert PCM to WAV Blob
                const wavBlob = pcmToWav(pcm16, sampleRate);
                
                // 5. Create URL and prepare player
                audioUrl = URL.createObjectURL(wavBlob);

                if (!audioPlayer) {
                    audioPlayer = document.createElement('audio');
                    audioPlayer.id = 'audioPlayer';
                    document.body.appendChild(audioPlayer);
                }

                audioPlayer.src = audioUrl;

                audioPlayer.onended = () => {
                    ttsButton.innerHTML = originalIcon;
                    ttsButton.disabled = false;
                    URL.revokeObjectURL(audioUrl);
                    // Restore explanation text on success
                    grammarExplanationEl.textContent = originalExplanation; 
                };

                await audioPlayer.play();

            } catch (error) {
                console.error('Error during Text-to-Speech:', error);
                
                // Show user-friendly error message in Arabic (Error Feedback)
                grammarExplanationEl.textContent = "عذراً، فشل تشغيل الصوت. تحقق من اتصالك بالإنترنت. (انظر Console للمزيد)";
                
                // Reset button immediately as playback failed
                ttsButton.innerHTML = originalIcon;
                ttsButton.disabled = false;
                if (audioUrl) URL.revokeObjectURL(audioUrl); 

                // Restore original explanation after 5 seconds
                setTimeout(() => {
                    grammarExplanationEl.textContent = originalExplanation;
                }, 5000); 

            } finally {
                // No need for further cleanup here, handled in catch/onended
            }
        }
    </script>
</body>
</html>
